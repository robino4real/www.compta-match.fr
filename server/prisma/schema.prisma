generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String      @id @default(cuid())
  email           String      @unique
  passwordHash    String      @default("")
  role            String      @default("user")
  isEmailVerified Boolean     @default(false)
  firstName       String?
  lastName        String?
  accountType     AccountType @default(INDIVIDUAL)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  orders              Order[]
  downloadLinks       DownloadLink[]
  analyticsEvents     AnalyticsEvent[]
  userEvents          UserEvent[]
  auditLogs           AuditLog[]
  adminTwoFactorCodes AdminTwoFactorCode[]
  profile             UserProfile?
  settings            UserSettings?
  subscriptions       UserSubscription[]
  appFiches           AppFiche[]
  accountingEntries   AccountingEntry[]
  accountingDocuments AccountingDocument[]
  clientQuestions     ClientQuestion[]
  newsletterSubscriptions NewsletterSubscriber[]
  activityEvents          CustomerActivityEvent[]
  customerMetrics         CustomerMetrics?
}

enum OrderStatus {
  PAID
  PENDING
  FAILED
  REFUNDED
  CANCELLED
}

enum OrderType {
  DOWNLOADABLE
  SUBSCRIPTION
}

enum SubscriptionBrand {
  CP
  CA
}

enum VatRegime {
  NO_VAT_293B
  STANDARD_VAT
  OTHER
}

enum AccountType {
  INDIVIDUAL
  PROFESSIONAL
  ASSOCIATION
  COMPANY
  ENTREPRENEUR
}

enum AppFicheType {
  COMPTAPRO
  COMPTASSO
}

model Order {
  id                String             @id @default(cuid())
  userId            String
  user              User               @relation(fields: [userId], references: [id])
  createdAt         DateTime           @default(now())
  paidAt            DateTime?
  status            OrderStatus        @default(PAID)
  isDeleted         Boolean            @default(false)
  deletedAt         DateTime?
  downloadToken     String?            @unique
  orderNumber       String             @unique
  orderType         OrderType          @default(DOWNLOADABLE)
  subscriptionBrand SubscriptionBrand?

  totalBeforeDiscount Int
  discountAmount      Int    @default(0)
  totalPaid           Int
  stripeFeeAmount     Int    @default(0)
  currency            String @default("EUR")

  promoCodeId String?
  promoCode   PromoCode? @relation(fields: [promoCodeId], references: [id])

  stripeSessionId       String? @unique
  stripePaymentIntentId String? @unique
  stripeEventId         String? @unique

  billingNameSnapshot    String?
  billingEmailSnapshot   String?
  billingAddressSnapshot String?
  acceptedTerms          Boolean @default(false)
  acceptedLicense        Boolean @default(false)

  items   OrderItem[]
  invoice Invoice?
  newsletterRevenueAttributions NewsletterRevenueAttribution[]
}

enum WebhookEventStatus {
  RECEIVED
  PROCESSED
  ERROR
}

model WebhookEventLog {
  id              String             @id @default(cuid())
  eventId         String             @unique
  type            String
  status          WebhookEventStatus @default(RECEIVED)
  sessionId       String?
  paymentIntentId String?
  orderId         String?
  message         String?
  rawPayload      Json?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
}

model OrderItem {
  id      String @id @default(cuid())
  orderId String
  order   Order  @relation(fields: [orderId], references: [id])

  productId String
  product   DownloadableProduct @relation(fields: [productId], references: [id])

  /// Variante sélectionnée (Windows ou MacOS)
  platform DownloadPlatform?

  /// Binaire sélectionné pour cette commande
  binaryId String?
  binary   DownloadableBinary? @relation(fields: [binaryId], references: [id])

  productNameSnapshot String
  priceCents          Int
  quantity            Int    @default(1)
  lineTotal           Int

  downloadLinks DownloadLink[]
}

model ClientQuestion {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject   String?
  question  String
  answer    String?
  published Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, createdAt])
  @@index([published, createdAt])
}

model DownloadableProduct {
  id               String                @id @default(cuid())
  slug             String                @unique
  name             String
  shortDescription String?
  longDescription  String?
  cardImageUrl     String?
  thumbnailUrl     String?
  featureBullets   Json?
  detailSlides     Json?
  detailHtml       String?
  priceCents       Int
  currency         String                @default("EUR")
  isActive         Boolean               @default(true)
  isArchived       Boolean               @default(false)
  archivedAt       DateTime?
  seoTitle         String?
  seoDescription   String?
  index            Boolean               @default(true)
  follow           Boolean               @default(true)
  ogImageUrl       String?
  categoryId       String?
  category         DownloadableCategory? @relation(fields: [categoryId], references: [id])
  createdAt        DateTime              @default(now())
  updatedAt        DateTime              @updatedAt

  /// Nom original du fichier lors de l'upload (ex: ComptaMini-1.0.0.exe)
  fileName String

  /// Taille du fichier en octets
  fileSize Int

  /// Type MIME du fichier (ex: application/x-msdownload, application/zip)
  fileMimeType String?

  /// Chemin de stockage interne sur le serveur (ex: "downloads/uuid-xxx.exe")
  storagePath String

  /// Fichiers téléchargeables associés (par plateforme)
  binaries DownloadableBinary[]

  items                  OrderItem[]
  downloadLinks          DownloadLink[]
  productAnalyticsEvents ProductAnalyticsEvent[]
  seoOverride            ProductSeo?
}

model DownloadableCategory {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products   DownloadableProduct[]
  promoCodes PromoCode[]
}

enum DownloadLinkStatus {
  ACTIVE
  USED
  EXPIRED
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ArticleCategory {
  ARTICLE
  TUTORIAL
}

model DownloadLink {
  id          String    @id @default(cuid())
  orderItemId String
  orderItem   OrderItem @relation(fields: [orderItemId], references: [id])

  userId    String?
  user      User?                @relation(fields: [userId], references: [id])
  productId String?
  product   DownloadableProduct? @relation(fields: [productId], references: [id])

  token             String             @unique
  status            DownloadLinkStatus @default(ACTIVE)
  maxDownloads      Int                @default(1)
  downloadCount     Int                @default(0)
  createdAt         DateTime           @default(now())
  firstDownloadedAt DateTime?
  expiresAt         DateTime?
  lastDownloadedAt  DateTime?
}

enum DownloadPlatform {
  WINDOWS
  MACOS
}

model DownloadableBinary {
  id           String              @id @default(cuid())
  productId    String
  product      DownloadableProduct @relation(fields: [productId], references: [id])
  platform     DownloadPlatform
  fileName     String
  fileSize     Int
  fileMimeType String?
  storagePath  String
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  orderItems OrderItem[]
}

model StripeSettings {
  id                 Int     @id @default(1)
  useLiveMode        Boolean @default(false)
  defaultCurrency    String  @default("EUR")
  testPublishableKey String?
  livePublishableKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PromoCode {
  id            String  @id @default(cuid())
  code          String  @unique
  description   String?
  discountType  String
  discountValue Int

  /// Cible du code promo (produit ou abonnement)
  targetType PromoTargetType @default(PRODUCT)

  /// Limite éventuelle à une catégorie de produits téléchargeables
  productCategoryId String?
  productCategory   DownloadableCategory? @relation(fields: [productCategoryId], references: [id])

  /// Indique si le code est utilisé dans le cadre d'un parrainage
  isReferral Boolean @default(false)

  /// Informations de parrainage
  sponsorName     String?
  sponsorEmail    String?
  sponsorPhone    String?
  sponsorAddress  String?
  sponsorBankName String?
  sponsorIban     String?
  sponsorBic      String?
  referralRate    Int?

  maxUses     Int?
  currentUses Int  @default(0)

  isActive Boolean @default(true)

  startsAt DateTime?
  endsAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
}

enum PromoTargetType {
  PRODUCT
  SUBSCRIPTION
}

model CompanySettings {
  id                Int       @id @default(1)
  companyName       String
  legalForm         String
  tradeName         String?
  addressLine1      String
  addressLine2      String?
  postalCode        String
  city              String
  country           String
  siren             String?
  siret             String?
  rcsCity           String?
  vatNumber         String?
  vatRegime         VatRegime @default(NO_VAT_293B)
  vatCustomMention  String?
  capital           String?
  contactEmail      String
  supportEmail      String?
  websiteUrl        String?
  invoiceFooterText String?
  logoUrl           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id            String   @id @default(cuid())
  orderId       String   @unique
  order         Order    @relation(fields: [orderId], references: [id])
  invoiceNumber String   @unique
  issueDate     DateTime

  billingName    String
  billingEmail   String
  billingAddress String?

  totalHT  Int
  totalTVA Int
  totalTTC Int
  currency String @default("EUR")

  sellerName              String?
  sellerLegalForm         String?
  sellerAddress           String?
  sellerPostalCode        String?
  sellerCity              String?
  sellerCountry           String?
  sellerSiren             String?
  sellerSiret             String?
  sellerRcsCity           String?
  sellerVatNumber         String?
  sellerVatRegime         String?
  sellerVatMention        String?
  sellerCapital           String?
  sellerWebsiteUrl        String?
  sellerContactEmail      String?
  sellerInvoiceFooterText String?
  sellerLogoUrl           String?

  pdfPath   String?
  createdAt DateTime @default(now())
}

model EmailSettings {
  id                  Int     @id @default(1)
  providerType        String  @default("OTHER")
  fromNameDefault     String
  fromEmailDefault    String
  replyToEmailDefault String?

  ordersFromEmail       String?
  billingEmail          String?
  supportEmail          String?
  technicalContactEmail String?

  smtpHost     String?
  smtpPort     Int?
  smtpUsername String?
  smtpPassword String?

  apiKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailTemplate {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  subject     String
  bodyHtml    String
  bodyText    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LegalPage {
  id             String   @id @default(cuid())
  key            String   @unique
  title          String
  slug           String   @unique
  content        String   @default("")
  isPublished    Boolean  @default(false)
  seoTitle       String?
  seoDescription String?
  index          Boolean  @default(true)
  follow         Boolean  @default(true)
  ogImageUrl     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Article {
  id              String        @id @default(cuid())
  title           String
  slug            String        @unique
  authorName      String?
  excerpt         String?
  content         String
  status          ArticleStatus @default(DRAFT)
  publishedAt     DateTime?
  coverImageUrl   String?
  readTimeMinutes Int?
  seoTitle        String?
  seoDescription  String?
  index           Boolean       @default(true)
  follow          Boolean       @default(true)
  ogImageUrl      String?
  category        ArticleCategory @default(ARTICLE)
  youtubeUrl      String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model SeoSettings {
  id                     Int      @id @default(1)
  siteName               String
  siteTagline            String?
  defaultTitle           String?
  titleTemplate          String?
  defaultMetaDescription String?
  defaultOgImageUrl      String?
  twitterHandle          String?
  facebookPageUrl        String?
  linkedinPageUrl        String?
  indexSite              Boolean  @default(true)
  defaultRobotsIndex     String?  @default("index")
  defaultRobotsFollow    String?  @default("follow")
  canonicalBaseUrl       String?
  customRobotsTxt        String?
  enableSitemap          Boolean  @default(true)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model SeoStaticPage {
  id              String   @id @default(cuid())
  key             String   @unique
  route           String
  title           String?
  metaDescription String?
  index           Boolean  @default(true)
  follow          Boolean  @default(true)
  ogImageUrl      String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

enum BrandTone {
  PROFESSIONAL
  PEDAGOGICAL
  DIRECT
}

model SeoSettingsV2 {
  id                     String   @id @default(cuid())
  singletonKey           String   @unique @default("global")
  siteName               String?
  defaultTitle           String?
  defaultDescription     String?
  defaultOgImageUrl      String?
  canonicalBaseUrl       String?
  defaultRobotsIndex     Boolean  @default(true)
  defaultRobotsFollow    Boolean  @default(true)
  robotsTxt              String?
  sitemapEnabled         Boolean  @default(true)
  sitemapIncludePages    Boolean  @default(true)
  sitemapIncludeProducts Boolean  @default(true)
  sitemapIncludeArticles Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model PageSeo {
  id             String     @id @default(cuid())
  pageId         String
  page           CustomPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  title          String?
  description    String?
  ogImageUrl     String?
  canonicalUrl   String?
  robotsIndex    Boolean?
  robotsFollow   Boolean?
  jsonLdOverride Json?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@unique([pageId])
}

model ProductSeo {
  id           String              @id @default(cuid())
  productId    String
  product      DownloadableProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  title        String?
  description  String?
  ogImageUrl   String?
  canonicalUrl String?
  robotsIndex  Boolean?
  robotsFollow Boolean?
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  @@unique([productId])
}

model GeoIdentity {
  id               String     @id @default(cuid())
  singletonKey     String     @unique @default("global")
  shortDescription String?
  longDescription  String?
  targetAudience   String?
  positioning      String?
  differentiation  String?
  brandTone        BrandTone?
  language         String?    @default("fr")
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
}

model GeoFaqItem {
  id        String   @id @default(cuid())
  order     Int      @default(0)
  question  String
  answer    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model GeoAnswer {
  id          String   @id @default(cuid())
  order       Int      @default(0)
  question    String
  shortAnswer String?
  longAnswer  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  type      String
  url       String?
  referrer  String?
  userAgent String?
  meta      Json?
  createdAt DateTime @default(now())

  @@index([type, createdAt])
}

model ProductAnalyticsEvent {
  id        String              @id @default(cuid())
  productId String
  product   DownloadableProduct @relation(fields: [productId], references: [id])
  type      String // 'view' | 'add_to_cart'
  createdAt DateTime            @default(now())

  @@index([productId, type, createdAt])
}

enum UserEventType {
  PAGE_VIEW
  CLICK
  PRODUCT_VIEW
  ADD_TO_CART
  CHECKOUT_START
}

model UserEvent {
  id        String        @id @default(cuid())
  userId    String?
  user      User?         @relation(fields: [userId], references: [id])
  sessionId String
  eventType UserEventType
  page      String?
  metadata  Json?
  createdAt DateTime      @default(now())

  @@index([eventType, createdAt])
  @@index([userId, createdAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  adminId    String
  admin      User     @relation(fields: [adminId], references: [id])
  action     String
  targetType String
  targetId   String
  metadata   Json?
  createdAt  DateTime @default(now())

  @@index([action, createdAt])
}

model AdminTwoFactorCode {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  code      String
  createdAt DateTime @default(now())
  expiresAt DateTime
  consumed  Boolean  @default(false)
  attempts  Int      @default(0)

  @@index([userId])
}

model HomepageSettings {
  id                     Int      @id @default(1)
  heroTitle              String
  heroSubtitle           String
  heroButtonLabel        String
  heroButtonUrl          String
  heroButtonLink         String   @default("")
  heroTitleTag           String   @default("h1")
  heroSubtitleTag        String   @default("p")
  heroButtonStyle        String   @default("primary")
  heroImageUrl           String?
  heroBackgroundImageUrl String?
  siteLogoUrl            String?
  navbarLogoUrl          String?
  faviconUrl             String?
  logoText               String?
  logoSquareText         String?
  navLinks               Json?
  primaryNavButton       Json?
  heroPrimaryCtaLabel    String?
  heroPrimaryCtaHref     String?
  heroIllustrationUrl    String?
  feature1Icon           String   @default("")
  feature1Title          String   @default("")
  feature1Text           String   @default("")
  feature2Icon           String   @default("")
  feature2Title          String   @default("")
  feature2Text           String   @default("")
  feature3Icon           String   @default("")
  feature3Title          String   @default("")
  feature3Text           String   @default("")
  featureCards           Json?
  features               Json?    @default("[]")
  heroSections           Json?    @default("[]")
  highlightedProductIds  Json?
  testimonials           Json?
  contentBlockTitle      String?
  contentBlockBody       String?
  blocks                 Json?    @default("[]")
  seoTitle               String?
  seoDescription         String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model CustomPage {
  id        String   @id @default(cuid())
  key       String   @unique
  route     String   @unique
  name      String
  status    String   @default("ACTIVE")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sections PageSection[]
  seo      PageSeo?
}

model PageSection {
  id                 String     @id @default(cuid())
  pageId             String
  page               CustomPage @relation(fields: [pageId], references: [id])
  order              Int
  label              String?
  type               String
  backgroundColor    String?
  backgroundImageUrl String?
  settings           Json?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  blocks         PageBlock[]
  whyChooseItems WhyChooseItem[]
}

model PageBlock {
  id        String      @id @default(cuid())
  sectionId String
  section   PageSection @relation(fields: [sectionId], references: [id])
  order     Int
  type      String
  data      Json
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
}

model WhyChooseItem {
  id          String      @id @default(cuid())
  sectionId   String
  section     PageSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  order       Int         @default(0)
  iconType    String
  title       String
  description String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model PaidServicePlan {
  id            String          @id @default(cuid())
  slug          String          @unique
  name          String
  subtitle      String?
  priceAmount   Decimal
  priceCurrency String
  pricePeriod   String
  isHighlighted Boolean         @default(false)
  isPublished   Boolean         @default(false)
  sortOrder     Int             @default(0)
  stripePriceId String?
  serviceType   PaidServiceType @default(COMPTAPRO)

  planARows     PaidServiceFeatureRow[] @relation("PlanA")
  planBRows     PaidServiceFeatureRow[] @relation("PlanB")
  subscriptions UserSubscription[]
}

model UserSubscription {
  id               String             @id @default(cuid())
  userId           String
  planId           String
  status           SubscriptionStatus @default(ACTIVE)
  currentPeriodEnd DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  user User            @relation(fields: [userId], references: [id])
  plan PaidServicePlan @relation(fields: [planId], references: [id])
}

model UserProfile {
  id             String      @id @default(cuid())
  userId         String      @unique
  firstName      String?
  lastName       String?
  companyName    String?
  vatNumber      String?
  siret          String?
  billingStreet  String?
  billingZip     String?
  billingCity    String?
  billingCountry String?
  phone          String?
  accountType    AccountType @default(INDIVIDUAL)

  user User @relation(fields: [userId], references: [id])
}

model UserSettings {
  id              String  @id @default(cuid())
  userId          String  @unique
  newsletterOptIn Boolean @default(false)
  alertsOptIn     Boolean @default(true)

  user User @relation(fields: [userId], references: [id])
}

model AppFiche {
  id        String       @id @default(cuid())
  type      AppFicheType
  ownerId   String
  name      String
  currency  String       @default("EUR")
  fiscalYearStartMonth Int @default(1)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  owner User @relation(fields: [ownerId], references: [id])

  accountingEntries AccountingEntry[]
  accountingDocuments AccountingDocument[]

  @@index([ownerId])
}

model AccountingEntry {
  id         String   @id @default(cuid())
  ficheId    String
  ownerId    String
  date       DateTime
  label      String
  amountCents Int
  account    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  fiche AppFiche @relation(fields: [ficheId], references: [id])
  owner User     @relation(fields: [ownerId], references: [id])

  @@index([ficheId, ownerId])
}

model AccountingDocument {
  id           String   @id @default(cuid())
  ficheId      String
  ownerId      String
  filename     String
  originalName String
  mimeType     String
  sizeBytes    Int
  storagePath  String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  fiche AppFiche @relation(fields: [ficheId], references: [id])
  owner User     @relation(fields: [ownerId], references: [id])

  @@index([ficheId, ownerId])
  @@unique([ownerId, storagePath])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
}

model PaidServiceFeatureRow {
  id          String          @id @default(cuid())
  label       String
  description String?
  sortOrder   Int             @default(0)
  serviceType PaidServiceType @default(COMPTAPRO)

  planAId       String?
  planBId       String?
  planAIncluded Boolean @default(false)
  planBIncluded Boolean @default(false)

  planA PaidServicePlan? @relation("PlanA", fields: [planAId], references: [id])
  planB PaidServicePlan? @relation("PlanB", fields: [planBId], references: [id])
}

model PaidServiceSection {
  id          String          @id @default(cuid())
  title       String
  body        String
  imageUrl    String?
  sortOrder   Int             @default(0)
  isPublished Boolean         @default(true)
  serviceType PaidServiceType @default(COMPTAPRO)
}

enum PaidServiceType {
  COMPTAPRO
  COMPTASSO
}

enum NewsletterSubscriberStatus {
  ACTIVE
  UNSUBSCRIBED
  BOUNCED
  COMPLAINED
  ANONYMIZED
}

enum NewsletterSubscriberSource {
  CHECKOUT
  POPUP
  ACCOUNT
  ADMIN_IMPORT
  ADMIN_MANUAL
}

enum NewsletterConsentAction {
  OPT_IN
  OPT_OUT
  DOUBLE_OPTIN_CONFIRMED
}

enum CustomerActivityEventType {
  USER_REGISTERED
  USER_LOGIN
  ORDER_CREATED
  ORDER_PAID
  DOWNLOAD_CREATED
  DOWNLOAD_USED
  PAGE_VIEW
}

enum NewsletterCampaignStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  PAUSED
  CANCELLED
  FAILED
}

enum NewsletterSendBatchStatus {
  QUEUED
  SENDING
  DONE
  FAILED
}

enum NewsletterSendLogStatus {
  QUEUED
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
  UNSUBSCRIBED
  FAILED
}

model NewsletterSubscriber {
  id            String                     @id @default(cuid())
  email         String                     @unique
  firstName     String?
  lastName      String?
  status        NewsletterSubscriberStatus @default(ACTIVE)
  source        NewsletterSubscriberSource @default(ADMIN_MANUAL)
  consentAt     DateTime
  consentSource String
  consentProof  Json?
  userId        String?
  user          User?                      @relation(fields: [userId], references: [id])
  tags          String[]                   @default([])
  preferencesJson Json?
  unsubscribedAt DateTime?
  createdAt     DateTime                   @default(now())
  updatedAt     DateTime                   @updatedAt

  consentLogs NewsletterConsentLog[]
  sendLogs    NewsletterSendLog[]
  segmentCaches NewsletterSegmentCache[]
  automationRuns NewsletterAutomationRun[]
  preferenceLogs NewsletterPreferenceLog[]
  score NewsletterScore?
  rgpdLogs RGPDLog[]

  @@index([email])
}

model NewsletterConsentLog {
  id           String                  @id @default(cuid())
  subscriberId String
  action       NewsletterConsentAction
  timestamp    DateTime                @default(now())
  meta         Json?

  subscriber NewsletterSubscriber @relation(fields: [subscriberId], references: [id])
}

model CustomerActivityEvent {
  id        String                    @id @default(cuid())
  userId    String?
  email     String?
  type      CustomerActivityEventType
  createdAt DateTime                  @default(now())
  meta      Json?

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([email])
}

model CustomerMetrics {
  userId         String   @id
  lastActivityAt DateTime?
  lastLoginAt    DateTime?
  ordersCount    Int      @default(0)
  totalSpent     Int      @default(0)
  lastOrderAt    DateTime?
  downloadsCount Int      @default(0)
  lastEmailOpenAt DateTime?
  lastEmailClickAt DateTime?
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model NewsletterTemplate {
  id                  String   @id @default(cuid())
  name                String   @unique
  subjectDefault      String
  previewTextDefault  String?
  html                String
  designJson          Json?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  campaigns NewsletterCampaign[]
  automationSteps NewsletterAutomationStep[]
}

model NewsletterCampaign {
  id             String                   @id @default(cuid())
  name           String
  subject        String
  previewText    String?
  status         NewsletterCampaignStatus @default(DRAFT)
  audienceJson   Json
  templateId     String?
  template       NewsletterTemplate?      @relation(fields: [templateId], references: [id])
  htmlSnapshot   String?
  scheduledAt    DateTime?
  startedAt      DateTime?
  finishedAt     DateTime?
  totalRecipients Int      @default(0)
  sentCount       Int      @default(0)
  deliveredCount  Int      @default(0)
  openCount       Int      @default(0)
  clickCount      Int      @default(0)
  bounceCount     Int      @default(0)
  complaintCount  Int      @default(0)
  unsubCount      Int      @default(0)
  createdByAdminId String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  batches NewsletterSendBatch[]
  sendLogs NewsletterSendLog[]
  links    NewsletterLink[]
  revenueAttributions NewsletterRevenueAttribution[]
}

model NewsletterSendBatch {
  id          String                     @id @default(cuid())
  campaignId  String
  campaign    NewsletterCampaign         @relation(fields: [campaignId], references: [id])
  status      NewsletterSendBatchStatus  @default(QUEUED)
  scheduledAt DateTime?
  startedAt   DateTime?
  finishedAt  DateTime?
  total       Int                        @default(0)
  sent        Int                        @default(0)
  failed      Int                        @default(0)
  createdAt   DateTime                   @default(now())
}

model NewsletterSendLog {
  id               String                  @id @default(cuid())
  campaignId       String
  subscriberId     String?
  subscriber       NewsletterSubscriber?   @relation(fields: [subscriberId], references: [id])
  email            String
  status           NewsletterSendLogStatus @default(QUEUED)
  error            String?
  providerMessageId String?
  sentAt           DateTime?
  deliveredAt      DateTime?
  openedAt         DateTime?
  clickedAt        DateTime?
  meta             Json?
  createdAt        DateTime                @default(now())
  updatedAt        DateTime                @updatedAt

  campaign NewsletterCampaign @relation(fields: [campaignId], references: [id])

  @@index([campaignId])
  @@index([email])
  @@index([status])
}

model NewsletterLink {
  id          String             @id @default(cuid())
  campaignId  String
  campaign    NewsletterCampaign @relation(fields: [campaignId], references: [id])
  originalUrl String
  token       String             @unique
  clickCount  Int                @default(0)
  createdAt   DateTime           @default(now())
}

enum NewsletterAutomationStatus {
  ACTIVE
  PAUSED
}

enum NewsletterAutomationTrigger {
  USER_REGISTERED
  ORDER_PAID
  NO_LOGIN_X_DAYS
  NO_ORDER_X_DAYS
  DOWNLOAD_NOT_USED
}

enum NewsletterAutomationRunStatus {
  RUNNING
  COMPLETED
  CANCELLED
}

model NewsletterSegment {
  id           String   @id @default(cuid())
  name         String   @unique
  description  String?
  rulesJson    Json
  previewCount Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  caches      NewsletterSegmentCache[]
  automations NewsletterAutomation[]
}

model NewsletterSegmentCache {
  id           String              @id @default(cuid())
  segmentId    String
  subscriberId String
  computedAt   DateTime            @default(now())

  segment    NewsletterSegment    @relation(fields: [segmentId], references: [id])
  subscriber NewsletterSubscriber @relation(fields: [subscriberId], references: [id])

  @@index([segmentId])
  @@index([subscriberId])
}

model NewsletterAutomation {
  id            String                       @id @default(cuid())
  name          String
  status        NewsletterAutomationStatus   @default(ACTIVE)
  trigger       NewsletterAutomationTrigger
  triggerConfig Json?
  segmentId     String?
  createdAt     DateTime                     @default(now())
  updatedAt     DateTime                     @updatedAt

  segment NewsletterSegment?     @relation(fields: [segmentId], references: [id])
  steps   NewsletterAutomationStep[]
  runs    NewsletterAutomationRun[]
}

model NewsletterAutomationStep {
  id            String @id @default(cuid())
  automationId  String
  stepOrder     Int
  type          String
  templateId    String
  delayMinutes  Int     @default(0)
  conditionsJson Json?
  exitOnEvent   Json?

  automation NewsletterAutomation @relation(fields: [automationId], references: [id])
  template   NewsletterTemplate   @relation(fields: [templateId], references: [id])

  @@index([automationId])
  @@index([templateId])
}

model NewsletterAutomationRun {
  id            String                        @id @default(cuid())
  automationId  String
  subscriberId  String
  status        NewsletterAutomationRunStatus @default(RUNNING)
  currentStep   Int                           @default(0)
  startedAt     DateTime                      @default(now())
  stepStartedAt DateTime                      @default(now())
  finishedAt    DateTime?
  updatedAt     DateTime                      @updatedAt

  automation NewsletterAutomation @relation(fields: [automationId], references: [id])
  subscriber NewsletterSubscriber @relation(fields: [subscriberId], references: [id])

  @@index([automationId])
  @@index([subscriberId])
}

model NewsletterRevenueAttribution {
  id           String   @id @default(cuid())
  campaignId   String
  orderId      String
  revenue      Int      @default(0)
  attributedAt DateTime @default(now())

  campaign NewsletterCampaign @relation(fields: [campaignId], references: [id])
  order    Order              @relation(fields: [orderId], references: [id])

  @@index([campaignId])
  @@index([orderId])
}

enum NewsletterPreferenceSource {
  EMAIL
  PUBLIC_PAGE
  ADMIN
}

model NewsletterPreferenceLog {
  id                  String   @id @default(cuid())
  subscriberId        String
  previousPreferences Json?
  newPreferences      Json?
  changedAt           DateTime @default(now())
  source              NewsletterPreferenceSource

  subscriber NewsletterSubscriber @relation(fields: [subscriberId], references: [id])

  @@index([subscriberId])
}

enum RGPDAction {
  EXPORT
  ANONYMIZE
  DELETE
}

model RGPDLog {
  id                  String   @id @default(cuid())
  subscriberId        String
  action              RGPDAction
  performedByAdminId  String?
  performedAt         DateTime @default(now())
  meta                Json?

  subscriber NewsletterSubscriber @relation(fields: [subscriberId], references: [id])
}

model NewsletterScore {
  subscriberId  String @id
  score         Int
  breakdownJson Json?
  lastComputedAt DateTime @default(now())

  subscriber NewsletterSubscriber @relation(fields: [subscriberId], references: [id])
}

enum DeliverabilityStatusEnum {
  OK
  NOK
  UNKNOWN
}

model NewsletterDeliverabilityStatus {
  id           String                  @id @default(cuid())
  domain       String                  @unique
  spfStatus    DeliverabilityStatusEnum @default(UNKNOWN)
  dkimStatus   DeliverabilityStatusEnum @default(UNKNOWN)
  dmarcStatus  DeliverabilityStatusEnum @default(UNKNOWN)
  lastCheckedAt DateTime?
}

enum NewsletterAlertType {
  BOUNCE_RATE
  COMPLAINT_RATE
  LOW_OPEN_RATE
  SEND_FREQUENCY
}

enum NewsletterAlertSeverity {
  INFO
  WARNING
  CRITICAL
}

model NewsletterAlert {
  id                String                   @id @default(cuid())
  type              NewsletterAlertType
  severity          NewsletterAlertSeverity  @default(WARNING)
  message           String
  relatedCampaignId String?
  createdAt         DateTime                 @default(now())
  acknowledgedAt    DateTime?
}
