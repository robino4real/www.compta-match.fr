generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  firstName String?
  lastName  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
  downloadLinks DownloadLink[]
}

enum OrderStatus {
  PAID
  PENDING
  FAILED
  REFUNDED
  CANCELLED
}

enum VatRegime {
  NO_VAT_293B
  STANDARD_VAT
  OTHER
}

model Order {
  id        String      @id @default(cuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id])
  createdAt DateTime    @default(now())
  paidAt    DateTime?
  status    OrderStatus @default(PAID)

  totalBeforeDiscount Int
  discountAmount      Int @default(0)
  totalPaid           Int
  currency            String      @default("EUR")

  promoCodeId String?
  promoCode   PromoCode? @relation(fields: [promoCodeId], references: [id])

  stripeSessionId       String? @unique
  stripePaymentIntentId String? @unique

  items   OrderItem[]
  invoice Invoice?
}

model OrderItem {
  id               String             @id @default(cuid())
  orderId          String
  order            Order              @relation(fields: [orderId], references: [id])

  productId        String
  product          DownloadableProduct @relation(fields: [productId], references: [id])

  productNameSnapshot String
  priceCents          Int
  quantity            Int                @default(1)
  lineTotal           Int

  downloadLinks DownloadLink[]
}

model DownloadableProduct {
  id               String   @id @default(cuid())
  slug             String   @unique
  name             String
  shortDescription String?
  longDescription  String?
  priceCents       Int
  currency         String   @default("EUR")
  isActive         Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  /// Nom original du fichier lors de l'upload (ex: ComptaMini-1.0.0.exe)
  fileName     String

  /// Taille du fichier en octets
  fileSize     Int

  /// Type MIME du fichier (ex: application/x-msdownload, application/zip)
  fileMimeType String?

  /// Chemin de stockage interne sur le serveur (ex: "downloads/uuid-xxx.exe")
  storagePath  String

  items OrderItem[]
  downloadLinks DownloadLink[]
}

enum DownloadLinkStatus {
  ACTIVE
  USED
  EXPIRED
}

model DownloadLink {
  id               String             @id @default(cuid())
  orderItemId      String
  orderItem        OrderItem          @relation(fields: [orderItemId], references: [id])

  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  productId String?
  product   DownloadableProduct? @relation(fields: [productId], references: [id])

  token            String             @unique
  status           DownloadLinkStatus @default(ACTIVE)
  maxDownloads     Int                @default(1)
  downloadCount    Int                @default(0)
  createdAt        DateTime           @default(now())
  firstDownloadedAt DateTime?
  expiresAt        DateTime?
  lastDownloadedAt DateTime?
}

model StripeSettings {
  id                 Int      @id @default(1)
  useLiveMode        Boolean  @default(false)
  defaultCurrency    String   @default("EUR")
  testPublishableKey String?
  livePublishableKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PromoCode {
  id            String   @id @default(cuid())
  code          String   @unique
  description   String?
  discountType  String
  discountValue Int

  maxUses     Int?
  currentUses Int      @default(0)

  isActive Boolean @default(true)

  startsAt DateTime?
  endsAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
}

model CompanySettings {
  id               Int      @id @default(1)
  companyName      String
  legalForm        String
  tradeName        String?
  addressLine1     String
  addressLine2     String?
  postalCode       String
  city             String
  country          String
  siren            String?
  siret            String?
  rcsCity          String?
  vatNumber        String?
  vatRegime        VatRegime @default(NO_VAT_293B)
  vatCustomMention String?
  capital          String?
  contactEmail     String
  supportEmail     String?
  websiteUrl       String?
  invoiceFooterText String?
  logoUrl          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id            String   @id @default(cuid())
  orderId       String   @unique
  order         Order    @relation(fields: [orderId], references: [id])
  invoiceNumber String   @unique
  issueDate     DateTime

  billingName    String
  billingEmail   String
  billingAddress String?

  totalHT  Int
  totalTVA Int
  totalTTC Int
  currency String @default("EUR")

  sellerName           String?
  sellerLegalForm      String?
  sellerAddress        String?
  sellerPostalCode     String?
  sellerCity           String?
  sellerCountry        String?
  sellerSiren          String?
  sellerSiret          String?
  sellerRcsCity        String?
  sellerVatNumber      String?
  sellerVatRegime      String?
  sellerVatMention     String?
  sellerCapital        String?
  sellerWebsiteUrl     String?
  sellerContactEmail   String?
  sellerInvoiceFooterText String?
  sellerLogoUrl        String?

  pdfPath   String?
  createdAt DateTime @default(now())
}

model EmailSettings {
  id                   Int      @id @default(1)
  providerType         String   @default("OTHER")
  fromNameDefault      String
  fromEmailDefault     String
  replyToEmailDefault  String?

  ordersFromEmail      String?
  billingEmail         String?
  supportEmail         String?
  technicalContactEmail String?

  smtpHost     String?
  smtpPort     Int?
  smtpUsername String?
  smtpPassword String?

  apiKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailTemplate {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  subject     String
  bodyHtml    String
  bodyText    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
