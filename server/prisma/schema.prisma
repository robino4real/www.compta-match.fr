generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  passwordHash String @default("")
  role      String   @default("user")
  isEmailVerified Boolean @default(false)
  firstName String?
  lastName  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
  downloadLinks DownloadLink[]
  analyticsEvents AnalyticsEvent[]
  adminTwoFactorCodes AdminTwoFactorCode[]
}

enum OrderStatus {
  PAID
  PENDING
  FAILED
  REFUNDED
  CANCELLED
}

enum VatRegime {
  NO_VAT_293B
  STANDARD_VAT
  OTHER
}

model Order {
  id        String      @id @default(cuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id])
  createdAt DateTime    @default(now())
  paidAt    DateTime?
  status    OrderStatus @default(PAID)

  totalBeforeDiscount Int
  discountAmount      Int @default(0)
  totalPaid           Int
  stripeFeeAmount     Int @default(0)
  currency            String      @default("EUR")

  promoCodeId String?
  promoCode   PromoCode? @relation(fields: [promoCodeId], references: [id])

  stripeSessionId       String? @unique
  stripePaymentIntentId String? @unique

  billingNameSnapshot   String?
  billingEmailSnapshot  String?
  billingAddressSnapshot String?
  acceptedTerms         Boolean   @default(false)
  acceptedLicense       Boolean   @default(false)

  items   OrderItem[]
  invoice Invoice?
}

model OrderItem {
  id               String             @id @default(cuid())
  orderId          String
  order            Order              @relation(fields: [orderId], references: [id])

  productId        String
  product          DownloadableProduct @relation(fields: [productId], references: [id])

  productNameSnapshot String
  priceCents          Int
  quantity            Int                @default(1)
  lineTotal           Int

  downloadLinks DownloadLink[]
}

model DownloadableProduct {
  id               String   @id @default(cuid())
  slug             String   @unique
  name             String
  shortDescription String?
  longDescription  String?
  thumbnailUrl     String?
  featureBullets   Json?
  detailHtml       String?
  priceCents       Int
  currency         String   @default("EUR")
  isActive         Boolean  @default(true)
  isArchived       Boolean  @default(false)
  archivedAt       DateTime?
  seoTitle         String?
  seoDescription   String?
  index            Boolean  @default(true)
  follow           Boolean  @default(true)
  ogImageUrl       String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  /// Nom original du fichier lors de l'upload (ex: ComptaMini-1.0.0.exe)
  fileName     String

  /// Taille du fichier en octets
  fileSize     Int

  /// Type MIME du fichier (ex: application/x-msdownload, application/zip)
  fileMimeType String?

  /// Chemin de stockage interne sur le serveur (ex: "downloads/uuid-xxx.exe")
  storagePath  String

  items OrderItem[]
  downloadLinks DownloadLink[]
  productAnalyticsEvents ProductAnalyticsEvent[]
}

enum DownloadLinkStatus {
  ACTIVE
  USED
  EXPIRED
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model DownloadLink {
  id               String             @id @default(cuid())
  orderItemId      String
  orderItem        OrderItem          @relation(fields: [orderItemId], references: [id])

  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  productId String?
  product   DownloadableProduct? @relation(fields: [productId], references: [id])

  token            String             @unique
  status           DownloadLinkStatus @default(ACTIVE)
  maxDownloads     Int                @default(1)
  downloadCount    Int                @default(0)
  createdAt        DateTime           @default(now())
  firstDownloadedAt DateTime?
  expiresAt        DateTime?
  lastDownloadedAt DateTime?
}

model StripeSettings {
  id                 Int      @id @default(1)
  useLiveMode        Boolean  @default(false)
  defaultCurrency    String   @default("EUR")
  testPublishableKey String?
  livePublishableKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PromoCode {
  id            String   @id @default(cuid())
  code          String   @unique
  description   String?
  discountType  String
  discountValue Int

  maxUses     Int?
  currentUses Int      @default(0)

  isActive Boolean @default(true)

  startsAt DateTime?
  endsAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
}

model CompanySettings {
  id               Int      @id @default(1)
  companyName      String
  legalForm        String
  tradeName        String?
  addressLine1     String
  addressLine2     String?
  postalCode       String
  city             String
  country          String
  siren            String?
  siret            String?
  rcsCity          String?
  vatNumber        String?
  vatRegime        VatRegime @default(NO_VAT_293B)
  vatCustomMention String?
  capital          String?
  contactEmail     String
  supportEmail     String?
  websiteUrl       String?
  invoiceFooterText String?
  logoUrl          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id            String   @id @default(cuid())
  orderId       String   @unique
  order         Order    @relation(fields: [orderId], references: [id])
  invoiceNumber String   @unique
  issueDate     DateTime

  billingName    String
  billingEmail   String
  billingAddress String?

  totalHT  Int
  totalTVA Int
  totalTTC Int
  currency String @default("EUR")

  sellerName           String?
  sellerLegalForm      String?
  sellerAddress        String?
  sellerPostalCode     String?
  sellerCity           String?
  sellerCountry        String?
  sellerSiren          String?
  sellerSiret          String?
  sellerRcsCity        String?
  sellerVatNumber      String?
  sellerVatRegime      String?
  sellerVatMention     String?
  sellerCapital        String?
  sellerWebsiteUrl     String?
  sellerContactEmail   String?
  sellerInvoiceFooterText String?
  sellerLogoUrl        String?

  pdfPath   String?
  createdAt DateTime @default(now())
}

model EmailSettings {
  id                   Int      @id @default(1)
  providerType         String   @default("OTHER")
  fromNameDefault      String
  fromEmailDefault     String
  replyToEmailDefault  String?

  ordersFromEmail      String?
  billingEmail         String?
  supportEmail         String?
  technicalContactEmail String?

  smtpHost     String?
  smtpPort     Int?
  smtpUsername String?
  smtpPassword String?

  apiKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailTemplate {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  subject     String
  bodyHtml    String
  bodyText    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LegalPage {
  id          String   @id @default(cuid())
  key         String   @unique
  title       String
  slug        String   @unique
  content     String   @default("")
  isPublished Boolean  @default(false)
  seoTitle        String?
  seoDescription  String?
  index           Boolean  @default(true)
  follow          Boolean  @default(true)
  ogImageUrl      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Article {
  id              String        @id @default(cuid())
  title           String
  slug            String        @unique
  authorName      String?
  excerpt         String?
  content         String
  status          ArticleStatus @default(DRAFT)
  publishedAt     DateTime?
  coverImageUrl   String?
  readTimeMinutes Int?
  seoTitle        String?
  seoDescription  String?
  index           Boolean       @default(true)
  follow          Boolean       @default(true)
  ogImageUrl      String?
  category        String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model SeoSettings {
  id                    Int      @id @default(1)
  siteName              String
  siteTagline           String?
  defaultTitle          String?
  titleTemplate         String?
  defaultMetaDescription String?
  defaultOgImageUrl     String?
  twitterHandle         String?
  facebookPageUrl       String?
  linkedinPageUrl       String?
  indexSite             Boolean  @default(true)
  defaultRobotsIndex    String?  @default("index")
  defaultRobotsFollow   String?  @default("follow")
  canonicalBaseUrl      String?
  customRobotsTxt       String?
  enableSitemap         Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model SeoStaticPage {
  id             String   @id @default(cuid())
  key            String   @unique
  route          String
  title          String?
  metaDescription String?
  index          Boolean  @default(true)
  follow         Boolean  @default(true)
  ogImageUrl     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  type      String
  url       String?
  referrer  String?
  userAgent String?
  meta      Json?
  createdAt DateTime @default(now())

  @@index([type, createdAt])
}

model ProductAnalyticsEvent {
  id        String   @id @default(cuid())
  productId String
  product   DownloadableProduct @relation(fields: [productId], references: [id])
  type      String   // 'view' | 'add_to_cart'
  createdAt DateTime @default(now())

  @@index([productId, type, createdAt])
}

model AdminTwoFactorCode {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  code      String
  createdAt DateTime @default(now())
  expiresAt DateTime
  consumed  Boolean  @default(false)
  attempts  Int      @default(0)

  @@index([userId])
}

model HomepageSettings {
  id                     Int      @id @default(1)
  heroTitle              String
  heroSubtitle           String
  heroButtonLabel        String
  heroButtonUrl          String
  heroImageUrl           String?
  heroBackgroundImageUrl String?
  siteLogoUrl            String?
  navbarLogoUrl          String?
  faviconUrl             String?
  logoText               String?
  logoSquareText         String?
  navLinks               Json?
  primaryNavButton       Json?
  heroPrimaryCtaLabel    String?
  heroPrimaryCtaHref     String?
  heroIllustrationUrl    String?
  featureCards           Json?
  features               Json?
  highlightedProductIds  Json?
  testimonials           Json?
  contentBlockTitle      String?
  contentBlockBody       String?
  seoTitle               String?
  seoDescription         String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model CustomPage {
  id        String        @id @default(cuid())
  key       String        @unique
  route     String        @unique
  name      String
  status    String        @default("ACTIVE")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  sections  PageSection[]
}

model PageSection {
  id                 String     @id @default(cuid())
  pageId             String
  page               CustomPage @relation(fields: [pageId], references: [id])
  order              Int
  label              String?
  type               String
  backgroundColor    String?
  backgroundImageUrl String?
  settings           Json?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  blocks PageBlock[]
}

model PageBlock {
  id        String       @id @default(cuid())
  sectionId String
  section   PageSection  @relation(fields: [sectionId], references: [id])
  order     Int
  type      String
  data      Json
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}
