generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  passwordHash String @default("")
  role      String   @default("user")
  isEmailVerified Boolean @default(false)
  firstName String?
  lastName  String?
  accountType AccountType @default(INDIVIDUAL)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
  downloadLinks DownloadLink[]
  analyticsEvents AnalyticsEvent[]
  adminTwoFactorCodes AdminTwoFactorCode[]
  profile UserProfile?
  settings UserSettings?
  subscriptions UserSubscription[]
}

enum OrderStatus {
  PAID
  PENDING
  FAILED
  REFUNDED
  CANCELLED
}

enum VatRegime {
  NO_VAT_293B
  STANDARD_VAT
  OTHER
}

enum AccountType {
  INDIVIDUAL
  PROFESSIONAL
  ASSOCIATION
}

model Order {
  id        String      @id @default(cuid())
  userId    String
  user      User        @relation(fields: [userId], references: [id])
  createdAt DateTime    @default(now())
  paidAt    DateTime?
  status    OrderStatus @default(PAID)
  downloadToken String? @unique

  totalBeforeDiscount Int
  discountAmount      Int @default(0)
  totalPaid           Int
  stripeFeeAmount     Int @default(0)
  currency            String      @default("EUR")

  promoCodeId String?
  promoCode   PromoCode? @relation(fields: [promoCodeId], references: [id])

  stripeSessionId       String? @unique
  stripePaymentIntentId String? @unique
  stripeEventId         String? @unique

  billingNameSnapshot   String?
  billingEmailSnapshot  String?
  billingAddressSnapshot String?
  acceptedTerms         Boolean   @default(false)
  acceptedLicense       Boolean   @default(false)

  items   OrderItem[]
  invoice Invoice?
}

enum WebhookEventStatus {
  RECEIVED
  PROCESSED
  ERROR
}

model WebhookEventLog {
  id              String              @id @default(cuid())
  eventId         String              @unique
  type            String
  status          WebhookEventStatus  @default(RECEIVED)
  sessionId       String?
  paymentIntentId String?
  orderId         String?
  message         String?
  rawPayload      Json?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
}

model OrderItem {
  id               String             @id @default(cuid())
  orderId          String
  order            Order              @relation(fields: [orderId], references: [id])

  productId        String
  product          DownloadableProduct @relation(fields: [productId], references: [id])

  /// Variante sélectionnée (Windows ou MacOS)
  platform         DownloadPlatform?

  /// Binaire sélectionné pour cette commande
  binaryId         String?
  binary           DownloadableBinary? @relation(fields: [binaryId], references: [id])

  productNameSnapshot String
  priceCents          Int
  quantity            Int                @default(1)
  lineTotal           Int

  downloadLinks DownloadLink[]
}

model DownloadableProduct {
  id               String   @id @default(cuid())
  slug             String   @unique
  name             String
  shortDescription String?
  longDescription  String?
  cardImageUrl     String?
  thumbnailUrl     String?
  featureBullets   Json?
  detailSlides     Json?
  detailHtml       String?
  priceCents       Int
  currency         String   @default("EUR")
  isActive         Boolean  @default(true)
  isArchived       Boolean  @default(false)
  archivedAt       DateTime?
  seoTitle         String?
  seoDescription   String?
  index            Boolean  @default(true)
  follow           Boolean  @default(true)
  ogImageUrl       String?
  categoryId       String?
  category         DownloadableCategory? @relation(fields: [categoryId], references: [id])
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  /// Nom original du fichier lors de l'upload (ex: ComptaMini-1.0.0.exe)
  fileName     String

  /// Taille du fichier en octets
  fileSize     Int

  /// Type MIME du fichier (ex: application/x-msdownload, application/zip)
  fileMimeType String?

  /// Chemin de stockage interne sur le serveur (ex: "downloads/uuid-xxx.exe")
  storagePath  String

  /// Fichiers téléchargeables associés (par plateforme)
  binaries     DownloadableBinary[]

  items OrderItem[]
  downloadLinks DownloadLink[]
  productAnalyticsEvents ProductAnalyticsEvent[]
}

model DownloadableCategory {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products DownloadableProduct[]
  promoCodes PromoCode[]
}

enum DownloadLinkStatus {
  ACTIVE
  USED
  EXPIRED
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model DownloadLink {
  id               String             @id @default(cuid())
  orderItemId      String
  orderItem        OrderItem          @relation(fields: [orderItemId], references: [id])

  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  productId String?
  product   DownloadableProduct? @relation(fields: [productId], references: [id])

  token            String             @unique
  status           DownloadLinkStatus @default(ACTIVE)
  maxDownloads     Int                @default(1)
  downloadCount    Int                @default(0)
  createdAt        DateTime           @default(now())
  firstDownloadedAt DateTime?
  expiresAt        DateTime?
  lastDownloadedAt DateTime?
}

enum DownloadPlatform {
  WINDOWS
  MACOS
}

model DownloadableBinary {
  id          String            @id @default(cuid())
  productId   String
  product     DownloadableProduct @relation(fields: [productId], references: [id])
  platform    DownloadPlatform
  fileName    String
  fileSize    Int
  fileMimeType String?
  storagePath String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  orderItems OrderItem[]
}

model StripeSettings {
  id                 Int      @id @default(1)
  useLiveMode        Boolean  @default(false)
  defaultCurrency    String   @default("EUR")
  testPublishableKey String?
  livePublishableKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model PromoCode {
  id            String   @id @default(cuid())
  code          String   @unique
  description   String?
  discountType  String
  discountValue Int

  /// Cible du code promo (produit ou abonnement)
  targetType PromoTargetType @default(PRODUCT)

  /// Limite éventuelle à une catégorie de produits téléchargeables
  productCategoryId String?
  productCategory   DownloadableCategory? @relation(fields: [productCategoryId], references: [id])

  /// Indique si le code est utilisé dans le cadre d'un parrainage
  isReferral Boolean @default(false)

  /// Informations de parrainage
  sponsorName    String?
  sponsorEmail   String?
  sponsorPhone   String?
  sponsorAddress String?
  sponsorBankName String?
  sponsorIban     String?
  sponsorBic      String?
  referralRate   Int?

  maxUses     Int?
  currentUses Int      @default(0)

  isActive Boolean @default(true)

  startsAt DateTime?
  endsAt   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]
}

enum PromoTargetType {
  PRODUCT
  SUBSCRIPTION
}

model CompanySettings {
  id               Int      @id @default(1)
  companyName      String
  legalForm        String
  tradeName        String?
  addressLine1     String
  addressLine2     String?
  postalCode       String
  city             String
  country          String
  siren            String?
  siret            String?
  rcsCity          String?
  vatNumber        String?
  vatRegime        VatRegime @default(NO_VAT_293B)
  vatCustomMention String?
  capital          String?
  contactEmail     String
  supportEmail     String?
  websiteUrl       String?
  invoiceFooterText String?
  logoUrl          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Invoice {
  id            String   @id @default(cuid())
  orderId       String   @unique
  order         Order    @relation(fields: [orderId], references: [id])
  invoiceNumber String   @unique
  issueDate     DateTime

  billingName    String
  billingEmail   String
  billingAddress String?

  totalHT  Int
  totalTVA Int
  totalTTC Int
  currency String @default("EUR")

  sellerName           String?
  sellerLegalForm      String?
  sellerAddress        String?
  sellerPostalCode     String?
  sellerCity           String?
  sellerCountry        String?
  sellerSiren          String?
  sellerSiret          String?
  sellerRcsCity        String?
  sellerVatNumber      String?
  sellerVatRegime      String?
  sellerVatMention     String?
  sellerCapital        String?
  sellerWebsiteUrl     String?
  sellerContactEmail   String?
  sellerInvoiceFooterText String?
  sellerLogoUrl        String?

  pdfPath   String?
  createdAt DateTime @default(now())
}

model EmailSettings {
  id                   Int      @id @default(1)
  providerType         String   @default("OTHER")
  fromNameDefault      String
  fromEmailDefault     String
  replyToEmailDefault  String?

  ordersFromEmail      String?
  billingEmail         String?
  supportEmail         String?
  technicalContactEmail String?

  smtpHost     String?
  smtpPort     Int?
  smtpUsername String?
  smtpPassword String?

  apiKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EmailTemplate {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  subject     String
  bodyHtml    String
  bodyText    String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LegalPage {
  id          String   @id @default(cuid())
  key         String   @unique
  title       String
  slug        String   @unique
  content     String   @default("")
  isPublished Boolean  @default(false)
  seoTitle        String?
  seoDescription  String?
  index           Boolean  @default(true)
  follow          Boolean  @default(true)
  ogImageUrl      String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Article {
  id              String        @id @default(cuid())
  title           String
  slug            String        @unique
  authorName      String?
  excerpt         String?
  content         String
  status          ArticleStatus @default(DRAFT)
  publishedAt     DateTime?
  coverImageUrl   String?
  readTimeMinutes Int?
  seoTitle        String?
  seoDescription  String?
  index           Boolean       @default(true)
  follow          Boolean       @default(true)
  ogImageUrl      String?
  category        String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
}

model SeoSettings {
  id                    Int      @id @default(1)
  siteName              String
  siteTagline           String?
  defaultTitle          String?
  titleTemplate         String?
  defaultMetaDescription String?
  defaultOgImageUrl     String?
  twitterHandle         String?
  facebookPageUrl       String?
  linkedinPageUrl       String?
  indexSite             Boolean  @default(true)
  defaultRobotsIndex    String?  @default("index")
  defaultRobotsFollow   String?  @default("follow")
  canonicalBaseUrl      String?
  customRobotsTxt       String?
  enableSitemap         Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model SeoStaticPage {
  id             String   @id @default(cuid())
  key            String   @unique
  route          String
  title          String?
  metaDescription String?
  index          Boolean  @default(true)
  follow         Boolean  @default(true)
  ogImageUrl     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  type      String
  url       String?
  referrer  String?
  userAgent String?
  meta      Json?
  createdAt DateTime @default(now())

  @@index([type, createdAt])
}

model ProductAnalyticsEvent {
  id        String   @id @default(cuid())
  productId String
  product   DownloadableProduct @relation(fields: [productId], references: [id])
  type      String   // 'view' | 'add_to_cart'
  createdAt DateTime @default(now())

  @@index([productId, type, createdAt])
}

model AdminTwoFactorCode {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  code      String
  createdAt DateTime @default(now())
  expiresAt DateTime
  consumed  Boolean  @default(false)
  attempts  Int      @default(0)

  @@index([userId])
}

model HomepageSettings {
  id                     Int      @id @default(1)
  heroTitle              String
  heroSubtitle           String
  heroButtonLabel        String
  heroButtonUrl          String
  heroButtonLink         String   @default("")
  heroTitleTag           String   @default("h1")
  heroSubtitleTag        String   @default("p")
  heroButtonStyle        String   @default("primary")
  heroImageUrl           String?
  heroBackgroundImageUrl String?
  siteLogoUrl            String?
  navbarLogoUrl          String?
  faviconUrl             String?
  logoText               String?
  logoSquareText         String?
  navLinks               Json?
  primaryNavButton       Json?
  heroPrimaryCtaLabel    String?
  heroPrimaryCtaHref     String?
  heroIllustrationUrl    String?
  feature1Icon           String   @default("")
  feature1Title          String   @default("")
  feature1Text           String   @default("")
  feature2Icon           String   @default("")
  feature2Title          String   @default("")
  feature2Text           String   @default("")
  feature3Icon           String   @default("")
  feature3Title          String   @default("")
  feature3Text           String   @default("")
  featureCards           Json?
  features               Json?    @default("[]")
  heroSections           Json?    @default("[]")
  highlightedProductIds  Json?
  testimonials           Json?
  contentBlockTitle      String?
  contentBlockBody       String?
  blocks                 Json?    @default("[]")
  seoTitle               String?
  seoDescription         String?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
}

model CustomPage {
  id        String        @id @default(cuid())
  key       String        @unique
  route     String        @unique
  name      String
  status    String        @default("ACTIVE")
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  sections  PageSection[]
}

model PageSection {
  id                 String     @id @default(cuid())
  pageId             String
  page               CustomPage @relation(fields: [pageId], references: [id])
  order              Int
  label              String?
  type               String
  backgroundColor    String?
  backgroundImageUrl String?
  settings           Json?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  blocks         PageBlock[]
  whyChooseItems WhyChooseItem[]
}

model PageBlock {
  id        String       @id @default(cuid())
  sectionId String
  section   PageSection  @relation(fields: [sectionId], references: [id])
  order     Int
  type      String
  data      Json
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
}

model WhyChooseItem {
  id          String      @id @default(cuid())
  sectionId   String
  section     PageSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  order       Int         @default(0)
  iconType    String
  title       String
  description String
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model PaidServicePlan {
  id            String   @id @default(cuid())
  slug          String   @unique
  name          String
  subtitle      String?
  priceAmount   Decimal
  priceCurrency String
  pricePeriod   String
  isHighlighted Boolean  @default(false)
  isPublished   Boolean  @default(false)
  sortOrder     Int      @default(0)
  stripePriceId String?
  serviceType   PaidServiceType @default(COMPTAPRO)

  planARows PaidServiceFeatureRow[] @relation("PlanA")
  planBRows PaidServiceFeatureRow[] @relation("PlanB")
  subscriptions UserSubscription[]
}

model UserSubscription {
  id               String              @id @default(cuid())
  userId           String
  planId           String
  status           SubscriptionStatus  @default(ACTIVE)
  currentPeriodEnd DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  user User @relation(fields: [userId], references: [id])
  plan PaidServicePlan @relation(fields: [planId], references: [id])
}

model UserProfile {
  id             String @id @default(cuid())
  userId         String @unique
  firstName      String?
  lastName       String?
  companyName    String?
  vatNumber      String?
  siret          String?
  billingStreet  String?
  billingZip     String?
  billingCity    String?
  billingCountry String?
  phone          String?
  accountType    AccountType @default(INDIVIDUAL)

  user User @relation(fields: [userId], references: [id])
}

model UserSettings {
  id              String @id @default(cuid())
  userId          String @unique
  newsletterOptIn Boolean @default(false)
  alertsOptIn     Boolean @default(true)

  user User @relation(fields: [userId], references: [id])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
}

model PaidServiceFeatureRow {
  id          String  @id @default(cuid())
  label       String
  description String?
  sortOrder   Int     @default(0)
  serviceType PaidServiceType @default(COMPTAPRO)

  planAId       String?
  planBId       String?
  planAIncluded Boolean @default(false)
  planBIncluded Boolean @default(false)

  planA PaidServicePlan? @relation("PlanA", fields: [planAId], references: [id])
  planB PaidServicePlan? @relation("PlanB", fields: [planBId], references: [id])
}

model PaidServiceSection {
  id          String  @id @default(cuid())
  title       String
  body        String
  imageUrl    String?
  sortOrder   Int     @default(0)
  isPublished Boolean @default(true)
  serviceType PaidServiceType @default(COMPTAPRO)
}

enum PaidServiceType {
  COMPTAPRO
  COMPTASSO
}
